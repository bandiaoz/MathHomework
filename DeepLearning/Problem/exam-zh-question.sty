%
% Copyright (c) 2022 Zeping Lee
% Released under the LaTeX Project Public License v1.3c License.
% Repository: https://gitee.com/xkwxdyy/exam-zh
%

\NeedsTeXFormat{LaTeX2e}

\RequirePackage{expl3}
\RequirePackage{xparse}

\ProvidesExplPackage {exam-zh-question} {2022-9-18} {v0.1.20}
  {exam-zh question module}


\RequirePackage { amsthm }
\@ifpackageloaded { tcolorbox }
  { \tcbuselibrary { breakable } }
  { \RequirePackage [ most ] { tcolorbox } }
% \RequirePackage { zref-savepos }
\RequirePackage { xeCJKfntef }

% https://github.com/CTeX-org/forum/issues/264#issuecomment-1200087776
\disable@package@load { etex }
  {
    \cs_set_eq:NN \globcount \newcount
    \cs_set_eq:NN \globdimen \newdimen
  }
\RequirePackage { linegoal }


\ExplSyntaxOff

\usetikzlibrary{shapes.misc}
\ExplSyntaxOn




\NewDocumentCommand \questionsetup { m }
  { \keys_set:nn { exam-zh / question } { #1 } }
\NewDocumentCommand \fillinsetup { m }
  { \keys_set:nn { exam-zh / fillin } { #1 } }

% ulem å®åŒ…é‡å®šä¹‰äº† \emphï¼Œä½¿ç”¨ \normalem æ¢å¤
\normalem


% question ç¯å¢ƒç›¸å…³å˜é‡

% è®¡æ•°å™¨
\int_new:N \g__examzh_question_index_int
% ç­”æ¡ˆé¢œè‰²
\tl_new:N \l__examzh_question_answer_color_tl
% é¢˜ç›®åˆ†æ•°
\int_new:N \l__examzh_question_points_int
% æ˜¯å¦æ˜¾ç¤ºé¢˜ç›®åˆ†æ•°
\bool_new:N \l__examzh_question_show_points_bool
\bool_new:N \l__examzh_question_show_points_auto_bool
% é¢˜ç›®åˆ†æ•°æ˜¯å¦å•ç‹¬æˆæ®µï¼Œè§£ç­”é¢˜éœ€è¦å•ç‹¬æˆæ®µ
\bool_new:N \l__examzh_question_points_separate_par_bool
% æ˜¯å¦æ˜¾ç¤ºæ‹¬å·
\bool_new:N \l__examzh_question_show_paren_bool
% æ˜¯å¦æ˜¾ç¤ºç­”æ¡ˆ
\bool_new:N \l__examzh_question_show_answer_bool
\bool_new:N \l__examzh_question_show_fillin_answer_bool
\bool_new:N \l__examzh_question_show_paren_answer_bool
% ä¸Šä¸‹çš„é—´è·
\skip_new:N \l__examzh_question_top_sep_skip
\skip_new:N \l__examzh_question_bottom_sep_skip
% label çš„å¯¹é½
\tl_new:N \l__examzh_question_label_align_tl


\keys_define:nn { exam-zh }
  { question .meta:nn = { exam-zh / question } {#1} }
\keys_define:nn { exam-zh }
  { problem .meta:nn = { exam-zh / problem } {#1} }


\keys_define:nn { exam-zh / question }
  {
    % æ‰‹åŠ¨è°ƒæ•´ question ç¯å¢ƒçš„è®¡æ•°å™¨
    index               .int_gset:N = \g__examzh_question_index_int ,
    % åˆ†æ•°
    points              .int_set:N = \l__examzh_question_points_int ,
    % åˆ†æ•°æ˜¾ç¤ºæ§åˆ¶
    show-points         .choice: ,
    show-points / auto  .code:n =
      { \bool_set_true:N \l__examzh_question_show_points_auto_bool } ,
    show-points / true  .code:n =
      {
        \bool_set_true:N  \l__examzh_question_show_points_bool
        \bool_set_false:N \l__examzh_question_show_points_auto_bool
      } ,
    show-points / false .code:n =
      {
        \bool_set_false:N \l__examzh_question_show_points_bool
        \bool_set_false:N \l__examzh_question_show_points_auto_bool
      } ,
    % åˆ†æ•°æ˜¯å¦å•ç‹¬æˆæ®µ
    points-separate-par .bool_set:N = \l__examzh_question_points_separate_par_bool ,
    % æ˜¯å¦æ˜¾ç¤ºç­”æ¡ˆ
    % show-answer         .bool_set:N = \l__examzh_question_show_answer_bool ,
    show-answer         .choice: ,
    show-answer / true .code:n = 
      {
        \bool_set_true:N \l__examzh_question_show_fillin_answer_bool
        \bool_set_true:N \l__examzh_question_show_paren_answer_bool
      },
    show-answer / false .code:n = 
      {
        \bool_set_false:N \l__examzh_question_show_fillin_answer_bool
        \bool_set_false:N \l__examzh_question_show_paren_answer_bool
      },
    % ä¸Šæ–¹é—´è·
    top-sep             .skip_set:N = \l__examzh_question_top_sep_skip ,
    % ä¸‹æ–¹é—´è·
    bottom-sep          .skip_set:N = \l__examzh_question_bottom_sep_skip ,
    label .tl_set:N = \l__examzh_question_label_tl,
    combine-fillin .bool_set:N = \l__examzh_question_combine_fillin_bool,
    combine-fillin-args .tl_set:N = \l__examzh_question_combine_fillin_args_tl,
    label-align .choices:nn =
      { left, center, right }
      { \tl_set_eq:NN \l__examzh_question_label_align_tl \l_keys_choice_tl },
    hang .bool_set:N = \l__examzh_question_hang_bool,
    points-prelabel .tl_set:N = \l__examzh_question_points_prelabel_tl,
    points-postlabel .tl_set:N = \l__examzh_question_points_postlabel_tl,
  }


\keys_set:nn { exam-zh / question }
  {
    index               = 1,
    points              = 0 ,
    show-points         = auto ,
    points-separate-par = false ,
    show-answer         = false ,
    top-sep             = .25em plus .25em minus .1em ,
    bottom-sep          = .25em plus .25em minus .1em ,
    label               = \arabic*.,
    combine-fillin      = false,
    label-align         = right,
    hang                = true,
    points-prelabel     = {ï¼ˆ},
    points-postlabel    = {åˆ†ï¼‰}
  }

\keys_define:nn { exam-zh / problem }
  {
    % æ‰‹åŠ¨è°ƒæ•´ question ç¯å¢ƒçš„è®¡æ•°å™¨
    index               .int_gset:N = \g__examzh_question_index_int ,
    % åˆ†æ•°
    points              .int_set:N = \l__examzh_question_points_int ,
    % åˆ†æ•°æ˜¾ç¤ºæ§åˆ¶
    show-points         .choice: ,
    show-points / auto  .code:n =
      { \bool_set_true:N \l__examzh_question_show_points_auto_bool } ,
    show-points / true  .code:n =
      {
        \bool_set_true:N  \l__examzh_question_show_points_bool
        \bool_set_false:N \l__examzh_question_show_points_auto_bool
      } ,
    show-points / false .code:n =
      {
        \bool_set_false:N \l__examzh_question_show_points_bool
        \bool_set_false:N \l__examzh_question_show_points_auto_bool
      } ,
    % åˆ†æ•°æ˜¯å¦å•ç‹¬æˆæ®µ
    points-separate-par .bool_set:N = \l__examzh_problem_points_separate_par_bool,
    % æ˜¯å¦æ˜¾ç¤ºç­”æ¡ˆ
    % show-answer         .bool_set:N = \l__examzh_question_show_answer_bool ,
    show-answer         .choice: ,
    show-answer / true .code:n = 
      {
        \bool_set_true:N \l__examzh_question_show_fillin_answer_bool
        \bool_set_true:N \l__examzh_question_show_paren_answer_bool
      },
    show-answer / false .code:n = 
      {
        \bool_set_false:N \l__examzh_question_show_fillin_answer_bool
        \bool_set_false:N \l__examzh_question_show_paren_answer_bool
      },
    % ä¸Šæ–¹é—´è·
    top-sep             .skip_set:N = \l__examzh_problem_top_sep_skip ,
    % ä¸‹æ–¹é—´è·
    bottom-sep          .skip_set:N = \l__examzh_problem_bottom_sep_skip ,
    label .tl_set:N = \l__examzh_question_label_tl,
    label-align .choices:nn =
      { left, center, right }
      { \tl_set_eq:NN \l__examzh_question_label_align_tl \l_keys_choice_tl },
    points-prelabel .tl_set:N = \l__examzh_problem_points_prelabel_tl,
    points-postlabel .tl_set:N = \l__examzh_problem_points_postlabel_tl,
  }

\keys_set:nn { exam-zh / problem }
  {
    index               = 1,
    points              = 0 ,
    show-points         = auto ,
    points-separate-par = true ,
    show-answer         = false ,
    top-sep             = .25em plus .25em minus .1em ,
    bottom-sep          = .25em plus .25em minus .1em ,
    label               = \arabic*.,
    label-align         = right,
    points-prelabel     = {ï¼ˆ},
    points-postlabel    = {åˆ†ï¼‰}
  }

% æ˜¯å¦æŒ‰ç…§è§£ç­”é¢˜çš„æ ¼å¼æ’ç‰ˆ
\bool_new:N \l__examzh_question_problem_style_bool


% é€‰æ‹©é¢˜å’Œå¡«ç©ºé¢˜çš„é¢˜å¹²
\NewDocumentEnvironment { question } { O { } +b }
  {
    \bool_set_false:N \l__examzh_question_problem_style_bool
    \__examzh_question_begin:nn {#1}{#2}
  }
  { \__examzh_question_end:nn {#1}{#2}  }

% è§£ç­”é¢˜
\NewDocumentEnvironment { problem } { O { } +b }
  {
    \bool_set_true:N \l__examzh_question_problem_style_bool
    \__examzh_problem_begin:nn {#1}{#2}
  }
  { \__examzh_problem_end:nn {#1}{#2} }

\prg_generate_conditional_variant:Nnn \int_compare:nNn { xNn } { T }
\cs_new:Npn \__examzh_question_begin:nn #1#2
  {
    \par
    % \bool_if:NTF \l__examzh_question_combine_fillin_bool
    %   { \keys_set:nn { exam-zh / question } { label-align = left } }
    %   { \keys_set:nn { exam-zh / question } { label-align = right } }
    % è®¾ç½®é”®å€¼
    \keys_set:nn { exam-zh / question } { #1 }
    % é¢˜å¹²è®¡æ•°å™¨çš„å€¼åŠ ä¸€
    \int_gincr:N \g__examzh_question_index_int
    % è®¾ç½®ä¸Šæ–¹é—´è·
    % \addvspace { \l__examzh_question_top_sep_skip }
    \vspace { \l__examzh_question_top_sep_skip }
    % ä¸¥æ ¼ç¦æ­¢å­¤è¡Œå’Œå¯¡è¡Œ
    \int_set:Nn \clubpenalty { 10000 }
    \int_set:Nn \widowpenalty { 10000 }
    % å°½é‡é¿å…åœ¨é¢˜ç›®ä¸­é—´æ¢è¡Œ
    \int_set:Nn \interlinepenalty { 301 }
    % è¿™éƒ¨åˆ†æ˜¯ä»¿ç…§ source2e ä¸­ enumerate çš„å®šä¹‰å†™çš„
    % \@enumdepth ä¸»è¦æ§åˆ¶ enumerate ä¸åŒå±‚çº§çš„ç¼–å·
    % è¿™æ ·è®¾ç½®åï¼Œåœ¨ question ä¸­ä½¿ç”¨ enumerate ä¼šè°ƒç”¨ level 2 çš„ç¼–å·
    % ä¹Ÿå°±æ˜¯ question ä¸­çš„ enumerate ç¯å¢ƒç›´æ¥ä»ç¬¬äºŒå±‚å¼€å§‹
    \int_incr:N \@enumdepth
    % å¦‚æœ show-points = auto é‚£ä¹ˆè§£ç­”é¢˜æ˜¾ç¤ºåˆ†æ•°ï¼Œé€‰æ‹©é¢˜å’Œå¡«ç©ºé¢˜ä¸æ˜¾ç¤ºåˆ†æ•°
    % è¿™æ ·è®¾ç½®è€ƒè™‘åˆ°é€‰æ‹©é¢˜å’Œå¡«ç©ºé¢˜éƒ½æ˜¯æ¯é“é¢˜ä¸€æ ·çš„åˆ†æ•°ï¼Œåœ¨æœ€å¼€å§‹çš„åœ°æ–¹è¯´æ˜å³å¯
    % è€Œè§£ç­”é¢˜ä¸å¤ªä¸€æ ·
    \bool_if:NT \l__examzh_question_show_points_auto_bool
      {
        \bool_set_false:N \l__examzh_question_show_points_bool
      }
    % ä½¿ç”¨åˆ—è¡¨ç¯å¢ƒè¾“å‡º
    \list 
      {
        % \int_use:N \g__examzh_question_index_int . 
        \__examzh_question_make_label:n
          {
            \bool_if:NT \l__examzh_question_combine_fillin_bool
              {
                \tl_if_blank:VTF \l__examzh_question_combine_fillin_args_tl
                  { \fillin }
                  {
                    \use:x
                      {
                        \exp_not:N \fillin \l__examzh_question_combine_fillin_args_tl
                      }
                  }
              }
            \int_compare:xNnT { \g__examzh_question_index_int } < { 11 }
              { \phantom {1} }
            \__examzh_question_the_label:
          }
      }
      {
        % ç”¨ group æ˜¯ä¸ºäº†é˜²æ­¢ combine-fillin çš„ type å½±å“äº†ç¯å¢ƒé‡Œé¢çš„ fillin çš„type
        \group_begin:
          \dim_gset:Nn \topsep       { 0pt }
          \dim_gset:Nn \partopsep    { 0pt }
          \dim_gset:Nn \itemsep      { 0pt }
          \dim_gset:Nn \parsep       { 0pt }
          % \group_begin:
            % ä¸Šé¢ \fillin é‡Œé¢çš„è®¾ç½®æ˜¯å±€éƒ¨çš„ï¼Œè¿™æ ·çš„é—®é¢˜æ˜¯ question çš„å¯é€‰å‚æ•°æ”¹ type çš„æ—¶å€™ä¸ä¼šå½±å“ \l__examzh_fillin_type_str çš„å€¼
            % æ‰€ä»¥è¦æŠŠ \l__examzh_question_combine_fillin_args_tl é‡Œå…³äº type çš„é€‰å–å‡ºæ¥
            \__examzh_question_begin_fillin_type_set:
            \__examzh_question_begin_labelsep_labelwidth_set:
          % \group_end:
          % \bool_if:NTF \l__examzh_question_problem_style_bool
          %   {
          %     % è§£ç­”é¢˜æ˜¯æ­£æ–‡ + ç¼©è¿› 2em çš„æ•ˆæœ
          %     \bool_if:NTF \l__examzh_question_combine_fillin_bool
          %       {
          %         % å¦‚æœ combine çš„è¯å°±å’Œ question ä¸€æ ·çš„ç¼©è¿›
          %         \bool_if:NTF \l__examzh_question_hang_bool
          %           { \dim_gset:Nn \itemindent { 0em } }
          %           { \dim_gset:Nn \itemindent { 2em } }
          %         \bool_if:NTF \l__examzh_question_combine_fillin_bool
          %           {
          %             \bool_if:NTF \l__examzh_question_hang_bool
          %               { \dim_gset:Nn \leftmargin { 6em } }
          %               { \dim_gset:Nn \leftmargin { 4em } }
          %           }
          %           {
          %             \bool_if:NTF \l__examzh_question_hang_bool
          %               { \dim_gset:Nn \leftmargin { 2em } }
          %               { \dim_gset:Nn \leftmargin { 0em } }
          %           }
          %       }
          %       {
          %         \dim_gset:Nn \leftmargin { 0pt }
          %         \dim_gset:Nn \itemindent { 2em }
          %       }
          %   }
            % {
              % é€‰æ‹©å’Œå¡«ç©ºé¢˜æ˜¯æ‚¬æŒ‚æ•ˆæœ
              \bool_if:NTF \l__examzh_question_hang_bool
                { \dim_gset:Nn \itemindent { 0em } }
                { \dim_gset:Nn \itemindent { 2em } }
              \bool_if:NTF \l__examzh_question_combine_fillin_bool
                {
                  \bool_if:NTF \l__examzh_question_hang_bool
                    { \dim_gset:Nn \leftmargin { 6em } }
                    { \dim_gset:Nn \leftmargin { 4em } }
                }
                {
                  \bool_if:NTF \l__examzh_question_hang_bool
                    { \dim_gset:Nn \leftmargin { 2em } }
                    { \dim_gset:Nn \leftmargin { 0em } }
                }
            % }
          \dim_gset_eq:NN \listparindent \itemindent
        \group_end:
      }
    \item \relax
    % è¾“å‡ºé¢˜ç›®åˆ†æ•°
    \bool_if:NT \l__examzh_question_show_points_bool
      {
        % å¦‚æœè®¾ç½®äº†åˆ†æ•°ä¸” show-points çš„ bool æ˜¯ true çš„è¯å°±æ˜¾ç¤º
        \int_compare:nNnT { \l__examzh_question_points_int } > { 0 }
          { \l__examzh_question_points_prelabel_tl \int_use:N \l__examzh_question_points_int ~ \l__examzh_question_points_postlabel_tl }
        % æ˜¯å¦åˆ†æ®µï¼ˆè§£ç­”é¢˜éœ€è¦åˆ†æ®µï¼‰
        \bool_if:NT \l__examzh_question_points_separate_par_bool
          % \par åˆ†æ®µä¹‹åä½¿ç”¨ \nopagebreak é¿å…åˆ†é¡µå¯¼è‡´åºå·å’Œåˆ†æ•°å‡ºç°åœ¨é¡µé¢æœ€åä¸€è¡Œ
          { \par \nopagebreak }   
      }
  }
\int_new:N \l__examzh_question_begin_fillin_args_bracket_num_int
\cs_generate_variant:Nn \regex_count:nnN { nVN }
\prg_generate_conditional_variant:Nnn \regex_extract_once:nnN { nxN } { F } 
\cs_new:Npn \__examzh_question_begin_fillin_type_set:
  {
    \regex_count:nVN { \[ } % \]
      \l__examzh_question_combine_fillin_args_tl
      \l__examzh_question_begin_fillin_args_bracket_num_int
    \use_none:n { \] }  % æ¶ˆå» \[ çš„é«˜äº®å½±å“
    % \int_use:N \l__examzh_question_begin_fillin_args_bracket_num_int
    \int_compare:nNnT { \l__examzh_question_begin_fillin_args_bracket_num_int } = {2}
      {
        \regex_extract_once:nxNF { \[ (.*?) \] } { \l__examzh_question_combine_fillin_args_tl } \l_tmpa_seq { \fail }
        \seq_pop_left:NN \l_tmpa_seq \l_tmpa_tl
        % \seq_use:Nn \l_tmpa_seq {,}
        \keys_set:nx { exam-zh / fillin } { \seq_use:Nn \l_tmpa_seq {,} }
      }
  }
\cs_new:Npn \__examzh_question_begin_labelsep_labelwidth_set:
  {
    \bool_if:NTF \l__examzh_question_combine_fillin_bool
      { 
        \str_case:Vn \l__examzh_question_label_align_tl
          {
            { left } 
              { 
                \str_case:VnF \l__examzh_fillin_type_str
                  {
                    { paren } 
                      { 
                        % combin-left-paren
                        \dim_gset:Nn \labelsep { 2.8em } 
                        \dim_gset:Nn \labelwidth { 4.2em } 
                      }
                    { line }
                      { 
                        % combin-left-line
                        \dim_gset:Nn \labelsep { 2.4em } 
                        \dim_gset:Nn \labelwidth { 3.8em } 
                      }
                  }
                  { 
                    % combin-left-paren/line å¤–çš„
                    \dim_gset:Nn \labelsep { 2.8em }
                    \dim_gset:Nn \labelwidth { 1.3em }
                  }
              }
            { center }
              { 
                \str_case:VnF \l__examzh_fillin_type_str
                  {
                    { paren } 
                      { 
                        % combin-center-paren
                        \dim_gset:Nn \labelsep { 2em } 
                        \dim_gset:Nn \labelwidth { 5em } 
                      }
                    { line }
                      { 
                        % combin-center-line
                        \dim_gset:Nn \labelsep { 2.8em } 
                        \dim_gset:Nn \labelwidth { 4em } 
                      }
                  }
                  { 
                    % combin-center-paren/line å¤–çš„
                    \dim_gset:Nn \labelsep { 2em }
                    \dim_gset:Nn \labelwidth { 1.3em }
                  }
              }
            { right  }
              {
                \dim_gset:Nn \labelsep { .7em } 
                \dim_gset:Nn \labelwidth { 1.3em }
              }
          }
      }
      {
        \str_case:Vn \l__examzh_question_label_align_tl
          {
            { left } 
              { 
                \dim_gset:Nn \labelsep { .7em }
                \dim_gset:Nn \labelwidth { 1.8em } 
              }
            { center }
              {
                \dim_gset:Nn \labelsep { .7em } 
                \dim_gset:Nn \labelwidth { 1.3em } 
              }
            { right  } 
              {
                \dim_gset:Nn \labelsep { .7em } 
                \dim_gset:Nn \labelwidth { 1.3em } 
              }
          }
        
      }
  }

\cs_new:Npn \__examzh_question_end:nn #1#2
  {
    #2
    % ç»“æŸåˆ—è¡¨ç¯å¢ƒ
    \endlist
    % å¢åŠ ä¸‹æ–¹é—´è·
    % \addvspace { \l__examzh_question_bottom_sep_skip }
    \vspace { \l__examzh_question_bottom_sep_skip }
  }

\cs_new:Npn \__examzh_problem_begin:nn #1#2
  {
    \par
    % \bool_if:NTF \l__examzh_question_combine_fillin_bool
    %   { \keys_set:nn { exam-zh / question } { label-align = left } }
    %   { \keys_set:nn { exam-zh / question } { label-align = right } }
    % è®¾ç½®é”®å€¼
    \keys_set:nn { exam-zh / problem } { #1 }
    % é¢˜å¹²è®¡æ•°å™¨çš„å€¼åŠ ä¸€
    \int_gincr:N \g__examzh_question_index_int
    % è®¾ç½®ä¸Šæ–¹é—´è·
    % \addvspace { \l__examzh_question_top_sep_skip }
    \vspace { \l__examzh_problem_top_sep_skip }
    % ä¸¥æ ¼ç¦æ­¢å­¤è¡Œå’Œå¯¡è¡Œ
    \int_set:Nn \clubpenalty { 10000 }
    \int_set:Nn \widowpenalty { 10000 }
    % å°½é‡é¿å…åœ¨é¢˜ç›®ä¸­é—´æ¢è¡Œ
    \int_set:Nn \interlinepenalty { 301 }
    % è¿™éƒ¨åˆ†æ˜¯ä»¿ç…§ source2e ä¸­ enumerate çš„å®šä¹‰å†™çš„
    % \@enumdepth ä¸»è¦æ§åˆ¶ enumerate ä¸åŒå±‚çº§çš„ç¼–å·
    % è¿™æ ·è®¾ç½®åï¼Œåœ¨ problem ä¸­ä½¿ç”¨ enumerate ä¼šè°ƒç”¨ level 2 çš„ç¼–å·
    % ä¹Ÿå°±æ˜¯ question ä¸­çš„ enumerate ç¯å¢ƒç›´æ¥ä»ç¬¬äºŒå±‚å¼€å§‹
    \int_incr:N \@enumdepth
    % å¦‚æœ show-points = auto é‚£ä¹ˆè§£ç­”é¢˜æ˜¾ç¤ºåˆ†æ•°ï¼Œé€‰æ‹©é¢˜å’Œå¡«ç©ºé¢˜ä¸æ˜¾ç¤ºåˆ†æ•°
    % è¿™æ ·è®¾ç½®è€ƒè™‘åˆ°é€‰æ‹©é¢˜å’Œå¡«ç©ºé¢˜éƒ½æ˜¯æ¯é“é¢˜ä¸€æ ·çš„åˆ†æ•°ï¼Œåœ¨æœ€å¼€å§‹çš„åœ°æ–¹è¯´æ˜å³å¯
    % è€Œè§£ç­”é¢˜ä¸å¤ªä¸€æ ·
    \bool_if:NT \l__examzh_question_show_points_auto_bool
      {
        \bool_set_true:N  \l__examzh_question_show_points_bool
      }
    % ä½¿ç”¨åˆ—è¡¨ç¯å¢ƒè¾“å‡º
    \list 
      {
        % \int_use:N \g__examzh_question_index_int . 
        \__examzh_question_make_label:n
          {
            \__examzh_question_the_label:
          }
      }
      {
        % ç”¨ group æ˜¯ä¸ºäº†é˜²æ­¢ combine-fillin çš„ type å½±å“äº†ç¯å¢ƒé‡Œé¢çš„ fillin çš„type
        \group_begin:
          \dim_gset:Nn \topsep       { 0pt }
          \dim_gset:Nn \partopsep    { 0pt }
          \dim_gset:Nn \itemsep      { 0pt }
          \dim_gset:Nn \parsep       { 0pt }
          % \group_begin:
            % ä¸Šé¢ \fillin é‡Œé¢çš„è®¾ç½®æ˜¯å±€éƒ¨çš„ï¼Œè¿™æ ·çš„é—®é¢˜æ˜¯ question çš„å¯é€‰å‚æ•°æ”¹ type çš„æ—¶å€™ä¸ä¼šå½±å“ \l__examzh_fillin_type_str çš„å€¼
            % æ‰€ä»¥è¦æŠŠ \l__examzh_question_combine_fillin_args_tl é‡Œå…³äº type çš„é€‰å–å‡ºæ¥
            \__examzh_question_begin_fillin_type_set:
            \__examzh_question_begin_labelsep_labelwidth_set:
          % \group_end:
          \dim_gset:Nn \leftmargin { 0pt }
          \dim_gset:Nn \itemindent { 2em }
          \dim_gset_eq:NN \listparindent \itemindent
        \group_end:
      }
    \item \relax
    % è¾“å‡ºé¢˜ç›®åˆ†æ•°
    \bool_if:NT \l__examzh_question_show_points_bool
      {
        % å¦‚æœè®¾ç½®äº†åˆ†æ•°ä¸” show-points çš„ bool æ˜¯ true çš„è¯å°±æ˜¾ç¤º
        \int_compare:nNnT { \l__examzh_question_points_int } > { 0 }
          { \l__examzh_problem_points_prelabel_tl \int_use:N \l__examzh_question_points_int ~ \l__examzh_problem_points_postlabel_tl }
        % æ˜¯å¦åˆ†æ®µï¼ˆè§£ç­”é¢˜éœ€è¦åˆ†æ®µï¼‰
        \bool_if:NT \l__examzh_problem_points_separate_par_bool
          % \par åˆ†æ®µä¹‹åä½¿ç”¨ \nopagebreak é¿å…åˆ†é¡µå¯¼è‡´åºå·å’Œåˆ†æ•°å‡ºç°åœ¨é¡µé¢æœ€åä¸€è¡Œ
          { \par \nopagebreak }   
      }
  }

\cs_new:Npn \__examzh_problem_end:nn #1#2
  {
    #2
    % ç»“æŸåˆ—è¡¨ç¯å¢ƒ
    \endlist
    % å¢åŠ ä¸‹æ–¹é—´è·
    % \addvspace { \l__examzh_question_bottom_sep_skip }
    \vspace { \l__examzh_problem_bottom_sep_skip }
  }

% å¤„ç† question / problem çš„ label
\tl_new:N \l__examzh_question_counters_commands_set_tl

\cs_new:Npn \__examzh_question_the_label:
  {
    \group_begin:
      % å®šä¹‰è®¡æ•°å™¨ç›¸å…³çš„å‘½ä»¤å‡½æ•°
      \l__examzh_question_counters_commands_set_tl
      % è¾“å‡ºå¤„ç†åçš„ label
      \l__examzh_question_label_tl
    \group_end:
  }
\cs_new:Npn \__examzh_question_make_label:n #1
  {
    \str_case:Vn \l__examzh_question_label_align_tl
      {
        { left   } { \rlap { #1 } \hss }
        { center } { \hss \clap { #1 } \hss }
        { right  } { \hss \llap { #1 } }
      }
  }
\NewDocumentCommand \AddQuestionCounter { m m }
  {
    % ç”Ÿæˆç”¨æˆ·å±‚å‘½ä»¤
    \tl_put_right:Nn \l__examzh_question_counters_commands_set_tl
      { \__examzh_process_counter:NNn #1 #2 { question } }
    % æŠŠæ ¸å¿ƒå‡½æ•°å­˜èµ·æ¥
    \cs_set_eq:cN { __examzh_question_save_ \cs_to_str:N #1 : } #2
    \cs_set_eq:cN { __examzh_question_save_ \cs_to_str:N #2 : } #2
  }

\AddQuestionCounter \arabic \@arabic
\AddQuestionCounter \alph   \@alph
\AddQuestionCounter \Alph   \@Alph
\AddQuestionCounter \roman  \@roman
\AddQuestionCounter \Roman  \@Roman

\cs_new:Npn \__examzh_process_counter:NNn #1#2#3
  % #1: \Alph
  % #2: \@Alph
  % #3: question / fillin
  {
    \cs_set:Npn #1 { \use:c { __examzh_ #3 _process_counter_aux:Nn } #2 }
    \cs_set:Npn #2 { \use:c { __examzh_ #3 _process_counter_aux:Nn } #2 }
  }

\cs_new:Npn \__examzh_question_process_counter_aux:Nn #1#2
  {
    \tl_if_eq:nnTF {#2} { * }
      {
        % \Alph*
        \use:c { __examzh_question_save_ \cs_to_str:N #1 : }
          { \int_eval:n { \g__examzh_question_index_int - 1 } }
      }
      {
        % \Alph{...}
        \use:c { __examzh_question_save_ \cs_to_str:N #1 : }
          {#2}
      }
  }


% å¤„ç† fillin/no-answer-type = counter çš„ label
\tl_new:N \l__examzh_fillin_counters_commands_set_tl


\cs_new:Npn \__examzh_fillin_the_label:
  {
    \group_begin:
      % å®šä¹‰è®¡æ•°å™¨ç›¸å…³çš„å‘½ä»¤å‡½æ•°
      \l__examzh_fillin_counters_commands_set_tl
      % è¾“å‡ºå¤„ç†åçš„ label
      \l__examzh_fillin_label_tl
    \group_end:
  }

\NewDocumentCommand \AddFillinCounter { m m }
  {
    % ç”Ÿæˆç”¨æˆ·å±‚å‘½ä»¤
    \tl_put_right:Nn \l__examzh_fillin_counters_commands_set_tl
      { \__examzh_process_counter:NNn #1 #2 { fillin } }
    % æŠŠæ ¸å¿ƒå‡½æ•°å­˜èµ·æ¥
    \cs_set_eq:cN { __examzh_fillin_save_ \cs_to_str:N #1 : } #2
    \cs_set_eq:cN { __examzh_fillin_save_ \cs_to_str:N #2 : } #2
  }

\AddFillinCounter \arabic \@arabic
\AddFillinCounter \alph   \@alph
\AddFillinCounter \Alph   \@Alph
\AddFillinCounter \roman  \@roman
\AddFillinCounter \Roman  \@Roman

\cs_new:Npn \__examzh_fillin_process_counter_aux:Nn #1#2
  {
    \tl_if_eq:nnTF {#2} { * }
      {
        % \Alph*
        \use:c { __examzh_fillin_save_ \cs_to_str:N #1 : }
          { \int_eval:n { \g__examzh_fillin_no_answer_counter_int - 1 } }
      }
      {
        % \Alph{...}
        \use:c { __examzh_fillin_save_ \cs_to_str:N #1 : }
          {#2}
      }
  }

% ä½¿ç”¨ä¸­æ–‡å­—ä½“ç›´æ¥è¾“å‡º unicode å¸¦åœˆæ•°å­—
% \circlednumber çš„å‚æ•°æ—¢å¯ä»¥æ¥å— LaTeX2e çš„ <counter>ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ¥å— <intexpr>ã€‚
\NewDocumentCommand \circlednumber { s m }
  {
    \int_if_exist:cTF { c@ #2 }
      { \int_set_eq:Nc \l_tmpa_int { c@#2 } }
      { \int_set:Nn \l_tmpa_int { #2 } }
    \IfBooleanTF {#1}
      {
        \exp_args:Nx \__examzh_tikz_circled_number:n { \int_use:N \l_tmpa_int }
      }
      {
        \exp_args:Nx \__examzh_question_circled_number:n { \int_use:N \l_tmpa_int }
      }
  }

\cs_new:Npn \__examzh_circled_number:nn #1#2
  {
    \int_set:Nn \l_tmpa_int {#1}
    \int_compare:nNnTF { \l_tmpa_int } = { 0 }
      { \int_set:Nn \l_tmpa_int { "24EA } }
      {
        \int_compare:nNnTF { \l_tmpa_int } < { 21 }
          { \int_add:Nn \l_tmpa_int { "245F } }
          {
            \int_compare:nNnTF { \l_tmpa_int } < { 36 }
              { \int_add:Nn \l_tmpa_int { "3250 } }
              {
                \int_compare:nNnTF { \l_tmpa_int } < { 51 }
                  { \int_add:Nn \l_tmpa_int { "32B0 } }
                  {
                    \msg_error:nnn { exam-zh / #2 }
                      { invalid-circled-number } { \int_use:N \l_tmpa_int }
                  }
              }
          }
      }
    \group_begin:
      \CJKfamily+ { }
      \symbol { \l_tmpa_int }
    \group_end:
  }

\msg_new:nnn { exam-zh / question } { invalid-circled-number }
{ Invalid~ circled~ number~ #1. }

\msg_new:nnn { exam-zh / fillin } { invalid-circled-number }
{ Invalid~ circled~ number~ #1. }

\cs_new:Npn \__examzh_question_circled_number:n #1
  { \__examzh_circled_number:nn {#1} { question } }
\cs_new:Npn \__examzh_fillin_circled_number:n #1
  { \__examzh_circled_number:nn {#1} { fillin } }

\AddQuestionCounter \circlednumber \__examzh_question_circled_number:n
\AddFillinCounter \circlednumber  \__examzh_fillin_circled_number:n

% tikz ç»˜åˆ¶å¸¦åœˆæ•°å­—
\fp_new:N \l__examzh_tikz_circled_number_xscale_fp   % æ°´å¹³å‹ç¼©ç³»æ•°
\fp_new:N \l__examzh_tikz_circled_number_yscale_fp   % å‚ç›´å‹ç¼©ç³»æ•°
\dim_new:N \l__examzh_tikz_circled_number_total_hegiht_dim   % æ•°å­—çš„æ€»é«˜åº¦
\dim_new:N \l__examzh_tikz_circled_number_radius_dim     % åŠå¾„

\cs_new:Npn \__examzh_tikz_circled_number_aux:n #1
  {
    % æ ¹æ®æ•°å­—å¤§å°è®¾ç½®å‹ç¼©ç³»æ•°
    \fp_set:Nn \l__examzh_tikz_circled_number_xscale_fp
      {
        \int_compare:nNnTF {#1} < { 10 } 
          { 0.9 }
          {
            \int_compare:nNnTF {#1} < { 100 }
              { 0.7 }
              { 0.5 }
          } 
      }
    \fp_set:Nn \l__examzh_tikz_circled_number_yscale_fp
      {
        \int_compare:nNnTF {#1} < { 10 } 
          { 0.9 }
          {
            \int_compare:nNnTF {#1} < { 100 }
              { 0.8 }
              { 0.6 }
          } 
      }
    % è·å–æ•°å­—çš„é«˜åº¦
    \hbox_set:Nn \l_tmpa_box {#1}
    \dim_set:Nn \l__examzh_tikz_circled_number_total_hegiht_dim
      { \box_ht:N \l_tmpa_box + \box_dp:N \l_tmpa_box  }
    % è®¾ç½®åœ†çš„åŠå¾„
    \dim_set:Nn \l__examzh_tikz_circled_number_radius_dim 
      { \dim_eval:n { \l__examzh_tikz_circled_number_total_hegiht_dim / 2 + 0.34 ex } }
    % ç»˜åˆ¶
    \tikz [ baseline ]
      {
        \node
          [ inner~sep = 0pt, outer~sep = 0pt ]
          at (0, \dim_use:N \l__examzh_tikz_circled_number_total_hegiht_dim / 2 ) 
          {
            \hbox_set:Nn \l_tmpa_box
              {
                \int_compare:nNnTF {#1} > {9}
                  { \textbf {#1} }
                  {#1}
              }
            \makebox[0.35em][c]
              { 
                % \scalebox { \fp_use:N \l__examzh_tikz_circled_number_xscale_fp } 
                  % [ \fp_use:N \l__examzh_tikz_circled_number_yscale_fp ] 
                \box_scale:Nnn \l_tmpa_box
                  { \fp_use:N \l__examzh_tikz_circled_number_xscale_fp }
                  { \fp_use:N \l__examzh_tikz_circled_number_yscale_fp } 
                \box_use_drop:N \l_tmpa_box
              }
          };
        \draw (0, \l__examzh_tikz_circled_number_total_hegiht_dim / 2 )
          circle ( \l__examzh_tikz_circled_number_radius_dim );
      }
  }
\cs_new:Npn \__examzh_tikz_circled_number:n #1
  {
    \__examzh_tikz_circled_number_aux:n { \int_eval:n {#1} }
  }
\AddQuestionCounter \tikzcirclednumber \__examzh_tikz_circled_number:n
\AddFillinCounter \tikzcirclednumber \__examzh_tikz_circled_number:n

% é€‰æ‹©é¢˜æ‹¬å·
% æ§åˆ¶æ‹¬å·æ˜¯å¦å³å¯¹é½
\bool_new:N \l__examzh_paren_type_hfill_bool
\keys_define:nn { exam-zh / paren }
  {
    show-answer .bool_set:N = \l__examzh_question_show_paren_answer_bool,
    text-color        .tl_set:N = \l__examzh_paren_text_color_tl ,
    % æ˜¯å¦æ˜¾ç¤ºé€‰æ‹©é¢˜çš„æ‹¬å·
    show-paren          .bool_set:N = \l__examzh_question_show_paren_bool ,
    type .choice:,
    type / hfill .code:n =
      {
        \bool_set_true:N \l__examzh_paren_type_hfill_bool
      },
    type / none .code:n =
      {
        \bool_set_false:N \l__examzh_paren_type_hfill_bool
      },
  }
\keys_set:nn { exam-zh / paren }
  {
    show-answer = false,
    text-color  = black,
    show-paren  = false,
    type        = hfill
  }
\keys_define:nn { exam-zh }
  { paren .meta:nn = { exam-zh / paren } {#1} }
\NewDocumentCommand \paren { O { } }
  {
    % å¦‚æœå¼€äº† show answer å°±é»˜è®¤ show paren 
    \bool_if:NT \l__examzh_question_show_paren_answer_bool
      { \bool_set_true:N \l__examzh_question_show_paren_bool }
    \bool_if:NT \l__examzh_question_show_paren_bool
      {
        % ä½¿æ‹¬å·å•ç‹¬æˆè¡Œæ—¶å±…äºå³ä¾§
        % \null -> \hbox{}
        % ğ–…ğ–Šğ–•ğ–ğ–“ğ–Œ ğ•·ğ–Šğ–Š, [Mar 19, 2022 at 22:47:07]:
          % è¿™ä¸ªå†™æ³•æ˜¯ä¸ºäº†å¤„ç†è¿™æ ·çš„æƒ…å†µï¼šå‡è®¾æ‹¬å·éœ€è¦ 3em å®½åº¦ï¼Œä½†æ˜¯å¦‚æœé¢˜å¹²æœ«å°¾åªå‰©ä¸‹äº† 2em çš„ç©ºç™½ï¼Œæ‹¬å·å°±å¿…è¦å¦èµ·ä¸€è¡Œï¼Œå¹¶ä¸”ç”¨ \hill æŠŠæ‹¬å·æ¨åˆ°æœ€å³ä¾§
          % æ‰€ä»¥ä¸­é—´ç”¨äº†ä¸¤ä¸ª \hfill
          % è‡³äº \nobreak å’Œ \allowbreak å¤§æ¦‚æ˜¯ä¸ºäº†èƒ½å¤ŸåŒæ—¶å¤„ç†ã€Œæ‹¬å·ä¸æ¢è¡Œã€å’Œã€Œæ‹¬å·æ¢è¡Œã€ä¸¤ç§æƒ…å†µ
          % è¿™é‡Œå‚è€ƒ source2e çš„ \@dottedtoclineï¼ˆç›®å½•çš„æ ¼å¼ï¼‰
        % æ§åˆ¶æ˜¯å¦ hfill åˆ°è¡Œå°¾
        \bool_if:NT \l__examzh_paren_type_hfill_bool
          {
            \nobreak \hfill \allowbreak
            \null \nobreak \hfill \nobreak
          }
        \hbox:n
          {
            ï¼ˆ
            \hbox_to_wd:nn { 3em }
              {
                \bool_if:NT \l__examzh_question_show_paren_answer_bool
                  { \hfill \__examzh_paren_print_answer:n {#1} \hfill }
              }
            ï¼‰ \kern -.4em
          }
      }
  }
% â€œæ‰“å°å‡ºâ€ç­”æ¡ˆå†…å®¹ å› ä¸º show è¢«ç”¨ä½œâ€œæ˜¾ç¤ºä¸å¦â€çš„å«ä¹‰äº†ï¼Œæ‰€ä»¥æ­¤å¤„ç”¨ print
\cs_new:Npn \__examzh_fillin_print_answer:n #1
  {
    % \group_begin:
      \tl_if_eq:NnF \l__examzh_fillin_text_color_tl { black }
        { \exp_args:NV \color \l__examzh_fillin_text_color_tl }
      #1
    % \group_end:
  }
\cs_new:Npn \__examzh_paren_print_answer:n #1
  {
    \group_begin:
      \tl_if_eq:NnF \l__examzh_paren_text_color_tl { black }
        { \exp_args:NV \color \l__examzh_paren_text_color_tl }
      #1
    \group_end:
  }


% fillin çš„ä¸‹åˆ’çº¿æ ·å¼æ§åˆ¶
\str_new:N \l__examzh_fillin_type_str

% fillin type = paren çš„æ‹¬å·ç±»å‹
\bool_new:N \l__examzh_fillin_paren_banjiao_bool

% fillin çš„ width è®¾ç½®æ–­è¡Œæ—¶æ˜¯è‡ªåŠ¨é“ºæ»¡è¡Œè¿˜æ˜¯ä¸¥æ ¼æŒ‰ç…§é•¿åº¦æ¥
\bool_new:N \l__examzh_fillin_width_fill_bool

% ä¸æ˜¾ç¤ºç­”æ¡ˆæ—¶æ˜¾ç¤ºçš„ç±»å‹
\str_new:N \l__examzh_fillin_no_answer_type_str

% no-answer-type = counter çš„è®¡æ•°å™¨
\int_new:N \g__examzh_fillin_no_answer_counter_int

\keys_define:nn { exam-zh / fillin }
  {
    type .code:n = 
      {
        \str_set:Nn \l__examzh_fillin_type_str {#1}
      },
    show-answer .bool_set:N = \l__examzh_question_show_fillin_answer_bool,
    width .dim_set:N = \l__examzh_fillin_F_width_dim,
    width-type .choice:,
    width-type / fill .code:n =
      { \bool_set_true:N \l__examzh_fillin_width_fill_bool },
    width-type / normal .code:n =
      { \bool_set_false:N \l__examzh_fillin_width_fill_bool },
    color .tl_set:N = \l__examzh_fillin_color_tl,
    text-color .tl_set:N = \l__examzh_fillin_text_color_tl,
    no-answer-type .choices:nn =
      { blacktriangle, counter, none }
      { \str_set:Nx \l__examzh_fillin_no_answer_type_str { \l_keys_choice_tl } },
    no-answer-counter-index .int_gset:N = \g__examzh_fillin_no_answer_counter_int,
    no-answer-counter-label .tl_set:N = \l__examzh_fillin_label_tl,
    paren-type .choice:,
    paren-type / banjiao .code:n = 
      { \bool_set_true:N \l__examzh_fillin_paren_banjiao_bool },
    paren-type / quanjiao .code:n = 
      { \bool_set_false:N \l__examzh_fillin_paren_banjiao_bool },
    depth .dim_set:N = \l__examzh_fillin_line_depth_dim
  }
\keys_set:nn { exam-zh / fillin }
  {
    type                     = line,
    show-answer              = false,
    width                    = 3em,
    color                    = black,
    text-color               = black,
    no-answer-type           = blacktriangle,
    no-answer-counter-index  = 1,
    no-answer-counter-label  = \arabic*,
    paren-type               = banjiao,
    width-type               = normal,
    depth                    = 0.4em
  }

\keys_define:nn { exam-zh }
  { fillin .meta:nn = { exam-zh / fillin } {#1} }


\dim_new:N \l__examzh_question_answer_depth_dim

% å¡«ç©ºå‘½ä»¤
% \fillin \fillin[] \fillin[][] åœ¨ show-answer = false çš„æƒ…å†µä¸‹
% no-answer-type = blacktriangle å°±æ˜¾ç¤ºé»‘è‰²ä¸‰è§’å½¢
% no-answer-type = counter ï¼šè®¡æ•°å™¨ï¼ˆè®¾è®¡æ¥æºäºå®Œå½¢å¡«ç©ºï¼‰
% no-answer-type = none ï¼šä¸æ˜¾ç¤º
\NewDocumentCommand \fillin { s O{} o }
  {
    \group_begin:
      \IfNoValueTF {#3}
        {
          \bool_if:NTF \l__examzh_question_show_fillin_answer_bool
            {
              % æ˜¾ç¤ºç­”æ¡ˆ
              \IfBooleanTF {#1}
                {
                  % \fillin*[]
                  \__examzh_fillin_breakline:n {#2}
                }
                {
                  % \fillin[]
                  \__examzh_fillin:n {#2}
                }
            }
            {
              % ä¸æ˜¾ç¤ºç­”æ¡ˆ
              \IfBooleanTF {#1}
                { \__examzh_fillin_no_answer_breakble_typeset: }
                { \__examzh_fillin_no_answer_unbreakble_typeset: }
            }
        }
        {
          \keys_set:nn { exam-zh / fillin } {#2}
          \bool_if:NTF \l__examzh_question_show_fillin_answer_bool
            {
              % æ˜¾ç¤ºç­”æ¡ˆ
              \IfBooleanTF {#1}
                {
                  % \fillin*[][]
                  \__examzh_fillin_breakline:n {#3}
                }
                {
                  % \fillin[][]
                  \__examzh_fillin:n {#3}
                }
            }
            {
              % ä¸æ˜¾ç¤ºç­”æ¡ˆ
              \IfBooleanTF {#1}
                { \__examzh_fillin_no_answer_breakble_typeset: }
                { \__examzh_fillin_no_answer_unbreakble_typeset: }
            }
        }
    \group_end:
    \space \ignorespaces
  }
\msg_new:nnn { exam-zh / fillin } { no-such-noanswertype }
  {
    There~is~no~such~noanswertype~named~#1!\\
    Please~read~the~manual~carefully!
  }
\cs_new:Npn \__examzh_fillin_no_answer_unbreakble_typeset:
  {
    \str_case:VnF \l__examzh_fillin_no_answer_type_str
      {
        { blacktriangle } { \__examzh_fillin_no_answer_typeset_blacktriangle: }
        { counter } { \__examzh_fillin_no_answer_typeset_counter: }
        { none } { \__examzh_fillin_output_unbreakable_F: }
      }
      {
        \msg_error:nnx { exam-zh / fillin } { no-such-noanswertype }
          { \l__examzh_fillin_no_answer_type_str }
      }
  }
\cs_new:Npn \__examzh_fillin_no_answer_breakble_typeset:
  {
    \str_case:VnF \l__examzh_fillin_no_answer_type_str
      {
        { blacktriangle } { \__examzh_fillin_no_answer_typeset_blacktriangle: }
        { counter } { \__examzh_fillin_no_answer_typeset_counter: }
        { none } { \__examzh_fillin_output_breakable_F: }
      }
      {
        \msg_error:nnx { exam-zh / fillin } { no-such-noanswertype }
          { \l__examzh_fillin_no_answer_type_str }
      }
  }
\cs_new:Npn \__examzh_fillin_no_answer_typeset_blacktriangle:
  {
    \__examzh_fillin_without_judge:n { \__examzh_fillin_blacktriangle: }
  }
\cs_new:Npn \__examzh_fillin_no_answer_typeset_counter:
  {
    \int_gincr:N \g__examzh_fillin_no_answer_counter_int
    \__examzh_fillin_without_judge:n
      { \__examzh_fillin_the_label: }
      % { \int_eval:n { \g__examzh_fillin_no_answer_counter_int - 1 } }
  }
\cs_new:Npn \__examzh_fillin_without_judge:n #1
  {
    % \ULdepth æ˜¯ \uline çš„ä¸‹åˆ’çº¿çš„æ·±åº¦
    \dim_set:Nn \ULdepth { 0.3em }
    % lazy ç‰ˆæœ¬æ˜¯æŒ‡éœ€è¦åˆ¤æ–­æ—¶æ‰å»è·å–å½“å‰ç”¨äºåˆ¤æ–­çš„ bool å€¼ 
    % è€Œä¸æ˜¯ç±»ä¼¼äºâ€œæå‰å±•å¼€â€ï¼Œå’Œé¡¹å­è¶Šåœ¨ LaTeX3 çš„ bç«™è§†é¢‘é‡Œè®²åˆ°çš„ lazy evaluation æƒ³æ³•ç›¸åŒ
    \hbox_set:Nn \l_tmpa_box { \__examzh_fillin_print_answer:n {#1} }
    \dim_set:Nn \l__examzh_question_answer_depth_dim
      { \box_dp:N \l_tmpa_box }
    \__examzh_fillin_output_T:
  }
\cs_new:Npn \__examzh_fillin:n #1
  {
    % \ULdepth æ˜¯ \uline çš„ä¸‹åˆ’çº¿çš„æ·±åº¦
    \dim_set:Nn \ULdepth { 0.3em }
    % lazy ç‰ˆæœ¬æ˜¯æŒ‡éœ€è¦åˆ¤æ–­æ—¶æ‰å»è·å–å½“å‰ç”¨äºåˆ¤æ–­çš„ bool å€¼ 
    % è€Œä¸æ˜¯ç±»ä¼¼äºâ€œæå‰å±•å¼€â€ï¼Œå’Œé¡¹å­è¶Šåœ¨ LaTeX3 çš„ bç«™è§†é¢‘é‡Œè®²åˆ°çš„ lazy evaluation æƒ³æ³•ç›¸åŒ
    \bool_lazy_and:nnTF
      { \bool_if_p:N \l__examzh_question_show_fillin_answer_bool }
      { \bool_not_p:n { \tl_if_empty_p:n {#1} } }
      {
        \hbox_set:Nn \l_tmpa_box { \__examzh_fillin_print_answer:n {#1} }
        \dim_set:Nn \l__examzh_question_answer_depth_dim
          { \box_dp:N \l_tmpa_box }
        \__examzh_fillin_output_T:
      }
      { 
        \__examzh_fillin_output_unbreakable_F:
      }
  }
\cs_new:Npn \__examzh_fillin_breakline:n #1
  {
    \bool_lazy_and:nnTF
      { \bool_if_p:N \l__examzh_question_show_fillin_answer_bool }
      { \bool_not_p:n { \tl_if_empty_p:n {#1} } }
      {
        \tl_set:Nn \l_tmpa_tl { \__examzh_fillin_print_answer:n {#1} }
        \__examzh_fillin_output_breakline_T:
      }
      { 
        \__examzh_fillin_output_breakable_F:
      }
  }
\msg_new:nnn { exam-zh } { no-fillin-type }
  {
    There~is~no~type~of~\fillin~named~#1!\\
    Please~read~the~manual~for~more~details.
  }
\cs_new:Npn \__examzh_fillin_output_T:
  {
    \str_case:VnF \l__examzh_fillin_type_str
      {
        { line } { \__examzh_fillin_uline_T: }
        { paren } { \__examzh_fillin_paren_T: }
        { circle } { \__examzh_fillin_circle_T: }
        { blank } { \__examzh_fillin_blank_T: }
        { rectangle } { \__examzh_fillin_rectangle_T: }
      }
      {
        \msg_error:nnx { exam-zh } { no-fillin-type }
          { \l__examzh_fillin_type_str }
      }
  }
\cs_new:Npn \__examzh_fillin_output_breakline_T:
  {
    \str_case:VnF \l__examzh_fillin_type_str
      {
        { line } { \__examzh_fillin_uline_breakline_T: }
        { paren } { \__examzh_fillin_paren_breakline_T: }
        { blank } { \__examzh_fillin_blank_breakline_T: }
      }
      {
        \msg_error:nnx { exam-zh } { no-breakable-fillin-type }
          { \l__examzh_fillin_type_str }
      }
  }
\msg_new:nnn { exam-zh } { no-breakable-fillin-type }
  {
    The~type~:~#1~ cannot~be~used~in~breakable~fillin~cmd.
  }
\cs_new:Npn \__examzh_fillin_output_breakable_F:
  {
    \str_case:VnF \l__examzh_fillin_type_str
      {
        { line } { \__examzh_fillin_uline_breakable_F: }
        { paren } { \__examzh_fillin_paren_breakable_F: }
        { circle } { \__examzh_fillin_circle_F: }
        { blank } { \__examzh_fillin_blank_breakable_F: }
        { rectangle } { \__examzh_fillin_rectangle_F: }
      }
      {
        \msg_error:nnx { exam-zh } { no-fillin-type }
          { \l__examzh_fillin_type_str }
      }
  }
\cs_new:Npn \__examzh_fillin_output_unbreakable_F:
  {
    \str_case:VnF \l__examzh_fillin_type_str
      {
        { line } { \__examzh_fillin_uline_unbreakable_F: }
        { paren } { \__examzh_fillin_paren_unbreakable_F: }
        { circle } { \__examzh_fillin_circle_F: }
        { blank } { \__examzh_fillin_blank_unbreakable_F: }
        { rectangle } { \__examzh_fillin_rectangle_F: }
      }
      {
        \msg_error:nnx { exam-zh } { no-fillin-type }
          { \l__examzh_fillin_type_str }
      }
  }
\cs_new:Npn \__examzh_fillin_uline_T:
  {
    % \uline
    \CJKunderline*
      [ depth = \l__examzh_fillin_line_depth_dim ]
      {
        \hspace* { 0.5em plus .5em minus .5em }
        \dim_compare:nNnTF { \l__examzh_question_answer_depth_dim } > { 0.2em }
          {
            \dim_sub:Nn \l__examzh_question_answer_depth_dim { 0.2em }
            \raisebox { \l__examzh_question_answer_depth_dim }
              { \box_use_drop:N \l_tmpa_box }
          }
          { \box_use_drop:N \l_tmpa_box }
        \hspace* { 0.5em plus .5em minus .5em }
      }
  }
\cs_new:Npn \__examzh_fillin_uline_breakable_F:
  {
    % \uline { \hspace* { \l__examzh_fillin_F_width_dim } } 
    \__examzh_fillin_breakable_hspace:NN \CJKunderline \allowbreak
  }
\cs_new:Npn \__examzh_fillin_uline_unbreakable_F:
  {
    \unskip
    \hspace* { 0.5em plus .5em minus .5em }
    \uline { \hspace* { \l__examzh_fillin_F_width_dim } }
    \ignorespaces
  }
% \cs_new:Nn \__examzh_fillin_uline:
  % {
    % \bgroup
    %   \color{ \l__examzh_fillin_text_color_tl } 
    %   \markoverwith{\textcolor{black}{\rule[-0.7ex]{2pt}{0.4pt}}}
    %   \ULon
% xeCJKfntef.sty
% xeCJK: ä¿®å¤ä¸‹åˆ’çº¿ä¸­æ•°å­¦å…¬å¼çš„é”™è¯¯å¤„ç†
% https://github.com/CTeX-org/ctex-kit/commit/ad44c6674bb377653544349f23b7c629bc9e4677
\RenewDocumentCommand \CJKunderline { s t- s o }
  {
    \xeCJK_ulem_group_begin:
      \xeCJK_fntef_boot:nnNNNn { underline } { uline } #1#2#3 {#4}
      \xeCJK_fntef_initial:nnn
        { \l__xeCJK_uline_depth_tl }
        { \l__xeCJK_uline_sep_tl }
        {
          \l__xeCJK_uline_format_tl
          \tex_vrule:D
            height \dim_eval:n { \l__xeCJK_uline_thickness_tl }
            depth \c_zero_dim
            width .2em
        }
      % ç»™ CJKunderline åŠ äº†é¢œè‰²æ§åˆ¶
      \color { \l__examzh_fillin_text_color_tl }
      \xeCJK_ulem_on:n
  }
  % }
\cs_new:Npn \__examzh_fillin_uline_breakline_T:
  {
    \CJKunderline*
      [ depth = \l__examzh_fillin_line_depth_dim ]
    % \uline
    % \__examzh_fillin_uline:
      {
        \hspace* { 0.5em plus .5em minus .5em }
        % \color{ \l__examzh_fillin_text_color_tl } 
        \l_tmpa_tl
        % ç­”æ¡ˆå¾ˆé•¿æ—¶ï¼Œä¸èƒ½å®Œå…¨æ˜¾ç¤ºï¼Œç­”æ¡ˆå¾ˆé•¿æ—¶ï¼Œä¸èƒ½å®Œå…¨æ˜¾ç¤º
        \hspace* { 0.5em plus .5em minus .5em }
      }
  }
\cs_new:Npn \__examzh_fillin_paren_T:
  {
    \unskip
    \bool_if:NTF \l__examzh_fillin_paren_banjiao_bool
      {
        (
          \hspace* { 0.5em plus .5em minus .5em }
          \group_begin:
            \box_use_drop:N \l_tmpa_box
          \group_end:
          \hspace* { 0.5em plus .5em minus .5em }
        )
      }
      {
        ï¼ˆ
          \hspace* { 0.5em plus .5em minus .5em }
          \group_begin:
            \box_use_drop:N \l_tmpa_box
          \group_end:
          \hspace* { 0.5em plus .5em minus .5em }
        ï¼‰
      }
    \ignorespaces
  }
\cs_new:Npn \__examzh_fillin_paren_breakline_T:
  {
    \unskip
    \bool_if:NTF \l__examzh_fillin_paren_banjiao_bool
      {
        (
          \hspace* { 0.5em plus .5em minus .5em }
          \group_begin:
            \l_tmpa_tl
          \group_end:
          \hspace* { 0.5em plus .5em minus .5em }
        )
      }
      {
        ï¼ˆ
          \hspace* { 0.5em plus .5em minus .5em }
          \group_begin:
            \l_tmpa_tl
          \group_end:
          \hspace* { 0.5em plus .5em minus .5em }
        ï¼‰
      }
    \ignorespaces
  }
\box_new:N \c__examzh_banjiao_right_brace_box
\box_new:N \c__examzh_quanjiao_right_brace_box
\hbox_set:Nn \c__examzh_banjiao_right_brace_box { ) }
\hbox_set:Nn \c__examzh_quanjiao_right_brace_box { ï¼‰ }
\dim_const:Nn \c__examzh_banjiao_right_brace_width_dim  % (
  { \box_wd:N \c__examzh_banjiao_right_brace_box }
\dim_const:Nn \c__examzh_quanjiao_right_brace_width_dim  % (
  { \box_wd:N \c__examzh_quanjiao_right_brace_box }
\cs_new:Npn \__examzh_fillin_paren_breakable_F:
  {
    \unskip
    \hspace* { 0.5em plus .5em minus .5em }
    \bool_if:NTF \l__examzh_fillin_paren_banjiao_bool
      {
        ( \__examzh_fillin_breakable_hspace:NN \use:n \nobreak \kern-\c__examzh_banjiao_right_brace_width_dim ) \allowbreak
      }
      {
        ï¼ˆ \__examzh_fillin_breakable_hspace:NN \use:n \nobreak \kern-\c__examzh_quanjiao_right_brace_width_dim ï¼‰\allowbreak
      }
    \ignorespaces
  }
\cs_new:Npn \__examzh_fillin_paren_unbreakable_F:
  {
    \unskip
    \hspace* { 0.5em plus .5em minus .5em }
    \bool_if:NTF \l__examzh_fillin_paren_banjiao_bool
      {
        ( \hspace* { \l__examzh_fillin_F_width_dim } )
      }
      {
        ï¼ˆ \hspace* { \l__examzh_fillin_F_width_dim } ï¼‰
      }
    \ignorespaces
  }
\cs_new:Npn \__examzh_fillin_blank_T:
  {
    \unskip
    \hspace* { 0.5em plus .5em minus .5em }
    \group_begin:
      \box_use_drop:N \l_tmpa_box
    \group_end: 
    \ignorespaces
  }
\cs_new:Npn \__examzh_fillin_blank_breakline_T:
  {
    \unskip
    \hspace* { 0.5em plus .5em minus .5em }
    \group_begin:
      \l_tmpa_tl 
    \group_end:
    \ignorespaces
  }
\cs_new:Npn \__examzh_fillin_blank_breakble_F:
  {
    % \hspace* { \l__examzh_fillin_F_width_dim }
    \__examzh_fillin_breakable_hspace:NN \use:n \allowbreak
  }
\cs_new:Npn \__examzh_fillin_blank_unbreakble_F:
  {
    \hspace* { \l__examzh_fillin_F_width_dim }
    % \__examzh_fillin_breakable_hspace:NN \use:n \allowbreak
  }
\tikzset
  {
    fillin-circle/.style = 
      {
        rounded~rectangle~west~arc = convex,
        draw, rounded~rectangle,
        color = \l__examzh_fillin_color_tl, text = \l__examzh_fillin_text_color_tl
      }
  }
\cs_new:Npn \__examzh_fillin_circle_T:
  {
    \hspace* { .5em minus .5em }
    \tikz[baseline=-3pt]
      {
        \node [fillin-circle] at (0,0) 
          { \box_use_drop:N \l_tmpa_box };
      }
    \hspace* { .5em minus .5em }
  }
\cs_new:Npn \__examzh_fillin_circle_F:
  {
    \hspace* { 0.5em plus .5em minus .5em }
    \tikz[baseline=-3pt]
      {
        \node [fillin-circle] at (0,0) 
          { \phantom{t} };
      }
    \hspace* { 0.5em plus .5em minus .5em }
  }
\cs_new:Npn \__examzh_fillin_rectangle_T:
  {
    \hspace* { .5em minus .5em }
    \begin{tikzpicture}[baseline = -3pt]
      \node[draw, color = \l__examzh_fillin_color_tl, text = \l__examzh_fillin_text_color_tl] 
        { \box_use_drop:N \l_tmpa_box };
    \end{tikzpicture}
    \hspace* { .5em minus .5em }
  }
\cs_new:Npn \__examzh_fillin_rectangle_F:
  {
    \hspace* { 0.5em plus .5em minus .5em }
    \begin{tikzpicture}[baseline = -3pt]
      \node[draw, color = \l__examzh_fillin_color_tl, text = \l__examzh_fillin_text_color_tl] 
        { \phantom{a} };
    \end{tikzpicture}
    \hspace* { 0.5em plus .5em minus .5em }
  }

% é€šè¿‡å¾ªç¯æ¥è¾¾åˆ°è‡ªåŠ¨æ–­è¡Œçš„ç©ºç™½ä¸‹åˆ’çº¿
\cs_generate_variant:Nn \dim_sub:Nn { NV }
\cs_generate_variant:Nn \dim_add:Nn { NV }
\cs_generate_variant:Nn \dim_set:Nn { NV, Nx }
% ç”¨æ¥æ£€æµ‹æ˜¯å¦å¤„äº list ç¯å¢ƒä¸­
\bool_new:N \l__if_list_bool
\int_new:N \l__list_depth_int
\cs_generate_variant:Nn \dim_set:Nn { Nx }
\AddToHook { cmd / list / after }
  {
    \bool_set_true:N \l__if_list_bool
    \int_incr:N \l__list_depth_int
    \dim_if_exist:cF { l__list_leftmargin_ \int_to_roman:n { \l__list_depth_int } _dim }
      {
        \dim_new:c { l__list_leftmargin_ \int_to_roman:n { \l__list_depth_int } _dim }
      }
    % ç”¨æ¥å‚¨å­˜ç›¸åº”å±‚çº§çš„ \leftmargin å€¼
    \dim_set_eq:cN { l__list_leftmargin_ \int_to_roman:n { \l__list_depth_int } _dim } \leftmargin
  }
\AddToHook { cmd / endlist  / before } 
  { \int_zero:N \l__list_depth_int }

\cs_new:Npn \__examzh_fillin_breakable_hspace:NN #1#2
  % #1: CJKunderline / use:n
  % #2: \allowbreak
  {
    \dim_set_eq:NN \l_tmpb_dim \linegoal
    % æ¯”è¾ƒ \l__examzh_fillin_F_width_dim å’Œ linegoal
    \dim_compare:nNnTF { \l__examzh_fillin_F_width_dim } > { \l_tmpb_dim }
      {
        % è¶…è¿‡ linegoal å°±æ’ä¸€æ®µ linegoalï¼Œç„¶å \l__examzh_fillin_F_width_dim å‡å» linegoal é•¿åº¦
        % \dim_set:NV \l_tmpa_dim \linegoal
        \dim_set:NV \l_tmpa_dim \l_tmpb_dim
        % æ˜¯å¦å¤„äº list ç¯å¢ƒä¸­
        \bool_if:NTF \l__if_list_bool
          {
            % åŠ ä¸Š 1 åˆ° å½“å‰å±‚çº§çš„ leftmargin æ‰èƒ½è®© list ä¸­çš„ linegoal æ­£å¸¸
            \int_step_inline:nn { \l__list_depth_int }
              {
                \dim_add:Nn \l_tmpa_dim { \dim_use:c { l__list_leftmargin_ \int_to_roman:n { ##1 } _dim } }
              }
            #1 { \hspace { \l_tmpa_dim } }
          }
          {
            % æ­£æ–‡ä¸­
            #1 { \hspace { \l_tmpb_dim } }
          }
        \dim_sub:NV \l__examzh_fillin_F_width_dim \l_tmpa_dim
        \dim_while_do:nNnn { \l__examzh_fillin_F_width_dim } > { \linewidth }
          {
            % å¾ªç¯ï¼š\l__examzh_fillin_F_width_dim å’Œ \linewidth æ¯”è¾ƒï¼Œå¤§çš„è¯å°±æ’ä¸€ä¸ªï¼Œç„¶åå‡æ‰ linewidth
            \\ #1 { \hspace* { \linewidth } }
            \dim_sub:Nn \l__examzh_fillin_F_width_dim { \linewidth }
          }
        % \\ #1 { \hspace* { \linewidth } }
        \dim_compare:nNnT { \l__examzh_fillin_F_width_dim } < { \linewidth }
          { 
            % æœ€åä¸€è¡Œæ˜¯å¦ fill
            \bool_if:NTF \l__examzh_fillin_width_fill_bool
              {
                \\ #1 { \hspace* { \linewidth } } 
              }
              {
                \\ #1 { \hspace* { \l__examzh_fillin_F_width_dim } } 
              }
          }
      }
      {
        #1 { \hspace* { \l__examzh_fillin_F_width_dim } }
      }
    #2
  }


\dim_new:N \l__examzh_blacktriangle_length_dim
\dim_set:Nn \l__examzh_blacktriangle_length_dim { .7em }
\cs_new:Npn \__examzh_fillin_blacktriangle:
  {
    \tikz[rounded~corners=0.5pt,baseline=0pt]
      {
        \fill[] (0,0) -- ++(60\c_colon_str \l__examzh_blacktriangle_length_dim) -- ++(-60\c_colon_str \l__examzh_blacktriangle_length_dim) -- cycle ;
      }
  }

\str_new:N \l__examzh_solution_blank_type_str
\keys_define:nn { exam-zh / solution }
  {
    show-solution .bool_set:N = \l__examzh_solution_show_bool,
    show-answer .bool_set:N = \l__examzh_solution_show_bool,
    show-qed      .bool_set:N = \l__examzh_solution_show_qed_bool,
    qedsymbol     .tl_set:N = \l__examzh_solution_qedsymbol_tl,
    label-content  .tl_set:N   = \l__examzh_solution_label_content_tl,
    label-punct    .tl_set:N   = \l__examzh_solution_label_punct_tl,
    score-showleader .bool_set:N = \l__examzh_score_show_leader_bool,
    score-pre-content .tl_set:N = \l__examzh_score_pre_content_tl,
    score-post-content .tl_set:N = \l__examzh_score_post_content_tl,
    score-format .tl_set:N = \l__examzh_score_format_tl,
    text-color .tl_set:N = \l__examzh_solution_text_color_tl,
    blank-type .choices:nn =
      { none, manual, hide }
      {
        \str_set:Nx \l__examzh_solution_blank_type_str { \l_keys_choice_tl }
      },
    blank-vsep .skip_set:N = \l__examzh_solution_blank_vsep_skip,
    top-sep    .skip_set:N = \l__examzh_solution_top_sep_skip,
    bottom-sep .skip_set:N = \l__examzh_solution_bottom_sep_skip,
    parbreak .bool_set:N = \l__examzh_solution_par_break_bool,
  }
\keys_set:nn { exam-zh / solution }
  {
    show-solution      = false,
    show-qed           = true,
    qedsymbol          = $\square$,
    label-content      = {è§£ç­”},
    label-punct        = {},
    score-showleader   = true,
    score-pre-content  = {},
    score-post-content = åˆ†,
    score-format       = \color{red},
    text-color         = black,
    blank-type         = none,
    blank-vsep         = 12ex plus 1ex minus 1ex,
    top-sep            = .25em plus .25em minus .1em,
    bottom-sep         = 0pt,
    parbreak           = false
  }
\keys_define:nn { exam-zh }
  { solution .meta:nn = { exam-zh / solution } {#1} }
% è§£ç­”é¢˜ç¯å¢ƒ
\NewDocumentEnvironment { solution } { O{ } +b }
  {
    % \addvspace { \l__examzh_solution_top_sep_skip }
    \vspace { \l__examzh_solution_top_sep_skip }
    \keys_set:nn { exam-zh / solution } {#1}
    % æ”¾åœ¨è¿™æ˜¯ä½¿å¾— \examsetup è®¾ç½® qedsymbol å¯ä»¥æ”¾åœ¨æ­£æ–‡åŒº
    \cs_set_eq:NN \qedsymbol \l__examzh_solution_qedsymbol_tl
    \bool_if:NTF \l__examzh_solution_show_bool
      {
        \__examzh_solution_print_answer:n {#2}
      }
      {
        \str_case:VnF \l__examzh_solution_blank_type_str
          {
            { none } { }
            { manual } { \addvspace { \l__examzh_solution_blank_vsep_skip } }
            { hide } { \__examzh_solution_simply_hide_solution:n {#2} }
          }
          {}
      }
    \par
    % \mode_leave_vertical:
    % \addvspace { \l__examzh_solution_bottom_sep_skip }
    \vspace { \l__examzh_solution_bottom_sep_skip }
  }
  {}
\cs_new:Npn \__examzh_solution_simply_hide_solution:n #1
  {
    \begin{tcolorbox}
      [
        invisible,
        frame~hidden,
        breakable,
        opacityback  = 0,
        opacityframe = 0,
        size  = minimal,
        width = \linewidth
      ]
      #1
    \end{tcolorbox}
  }
\cs_new:Npn \__examzh_solution_print_answer:n #1
  {
    \par
    \pushQED { \qed }
    % \normalfont \topsep6 \p@ \@plus6 \p@ \relax
    % \trivlist
    % \item \relax
    \group_begin:
      % \hspace* { 2\ccwd }
      \bfseries  \l__examzh_solution_label_content_tl  
      \@addpunct { \l__examzh_solution_label_punct_tl }
    \group_end:
    \hspace{0.5em} 
    % \ignorespaces
    % æ˜¯å¦è¦æ–°èµ·ä¸€æ®µå¼€å§‹
    \bool_if:NT \l__examzh_solution_par_break_bool { \par }
    % \group_begin:
    \begingroup
      \color { \l__examzh_solution_text_color_tl } #1
    \endgroup
    % \group_end:
    \bool_if:NT \l__examzh_solution_show_qed_bool
      { \popQED }
    % \endtrivlist 
    % \@endpefalse
  }

% https://github.com/CTeX-org/forum/issues/256#issuecomment-1172319787
\zref@require@unique

\NewDocumentCommand { \score } { O{} m }
  {
    \group_begin:
      \keys_set:nn { exam / question } {#1}
      \mode_if_math:TF
        { 
          \__examzh_score_math_version:n { #2 }
        }
        { 
          \__examzh_score_text_version:n { #2 }
        }
    \group_end:
  }
\cs_new:Npn \__examzh_score_math_version:n #1
  {
    \bool_if:NTF \l__examzh_score_show_leader_bool
      {
        \__examzh_math_cdotfill:n 
          { 
            \group_begin:
              \l__examzh_score_format_tl
              \l__examzh_score_pre_content_tl
              #1
              \l__examzh_score_post_content_tl 
            \group_end:
          }
      }
      {
        \__examzh_math_nodotfill:n
          {
            { 
              \group_begin:
                \l__examzh_score_format_tl
                \l__examzh_score_pre_content_tl
                #1
                \l__examzh_score_post_content_tl 
              \group_end:
            }
          }
      }
  }
\cs_new:Npn \__examzh_score_text_version:n #1
  {
    \bool_if:NTF \l__examzh_score_show_leader_bool
      {
        \group_begin:
          \__examzh_cdotfill:
          \l__examzh_score_format_tl
          \l__examzh_score_pre_content_tl #1 \l__examzh_score_post_content_tl 
        \group_end:
      }
      {
        \hfill
        \group_begin:
          \l__examzh_score_format_tl
          \l__examzh_score_pre_content_tl #1 \l__examzh_score_post_content_tl
        \group_end:
      }
    \par \noindent \ignorespaces
  }
% ä»¿ç…§ latex.ltx, line 651 çš„ \dotfill
\cs_new:Npn \__examzh_cdotfill:
  {
    \mode_leave_vertical:
    \cleaders
      \hbox_to_wd:nn { .44em } { \hss $\cdot$ \hss }
      \hfill \kern\z@
  }
\cs_new_protected:Npn \__examzh_math_nodotfill:n #1
  {
    \stepcounter { zref@unique }
    \hbox_overlap_right:n
      {
        \zsaveposx { \thezref@unique L }
        \zref@ifrefundefined { \thezref@unique R }
          { }
          {
            \skip_horizontal:n
              {
                  \zposx { \thezref@unique R } sp
                - \zposx { \thezref@unique L } sp
              }
          }
      }
    \tag * { \zsaveposx { \thezref@unique R } #1 }
  }
\cs_new_protected:Npn \__examzh_math_cdotfill:n #1
  {
    \stepcounter { zref@unique }
    \hbox_overlap_right:n
      {
        \zsaveposx { \thezref@unique L }
        \zref@ifrefundefined { \thezref@unique R }
          { }
          {
            \cleaders
              \hbox_to_wd:nn { .44em } { \hss $\cdot$ \hss }
              \skip_horizontal:n
                {
                    \zposx { \thezref@unique R } sp
                  - \zposx { \thezref@unique L } sp
                }
          }
      }
    \tag * { \zsaveposx { \thezref@unique R } #1 }
  }

\endinput